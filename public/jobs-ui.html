<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>File Conversion Jobs UI</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 12px; }
        .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin-bottom: 16px; }
        label { display:block; margin: 8px 0 4px; }
        input, select, button { padding: 8px; font-size: 14px; }
        button { cursor: pointer; }
        code, pre { background:#f6f6f6; padding: 8px; border-radius: 8px; display:block; overflow:auto; }
        .row { display:flex; gap:12px; flex-wrap: wrap; align-items: end; }
        .row > div { flex: 1; min-width: 220px; }
        .ok { color: #0a7a0a; font-weight: 600; }
        .bad { color: #b00020; font-weight: 600; }
    </style>
</head>
<body>
<h1>File Conversion Service</h1>

<div class="card">
    <h2>Create job (POST /api/jobs)</h2>
    <div class="row">
        <div>
            <label>File (csv/json/xlsx/ods)</label>
            <input id="file" type="file" />
        </div>
        <div>
            <label>Output format</label>
            <select id="outputFormat">
                <option value="json">json</option>
                <option value="xml">xml</option>
            </select>
        </div>
        <div>
            <button id="createBtn">Create job</button>
        </div>
    </div>
    <p id="createStatus"></p>
    <pre id="createResult"></pre>
</div>

<div class="card">
    <h2>Check status (GET /api/jobs/{id})</h2>
    <div class="row">
        <div>
            <label>Job ID</label>
            <input id="jobId" placeholder="paste job id here" />
        </div>
        <div>
            <button id="checkBtn">Check</button>
            <button id="pollBtn">Poll every 2s</button>
            <button id="stopPollBtn">Stop</button>
        </div>
    </div>
    <p id="checkStatus"></p>
    <pre id="checkResult"></pre>
</div>

<div class="card">
    <h2>Download (GET /api/jobs/{id}/download)</h2>
    <div class="row">
        <div>
            <label>Job ID</label>
            <input id="downloadJobId" placeholder="paste job id here" />
        </div>
        <div>
            <button id="downloadBtn">Download</button>
        </div>
    </div>
    <p id="downloadStatus"></p>
</div>

<script>
    const el = (id) => document.getElementById(id);
    let pollTimer = null;

    function setMsg(target, msg, ok=true) {
        target.textContent = msg;
        target.className = ok ? 'ok' : 'bad';
    }

    async function createJob() {
        const file = el('file').files[0];
        const outputFormat = el('outputFormat').value;

        if (!file) {
            setMsg(el('createStatus'), 'Select a file first', false);
            return;
        }

        const form = new FormData();
        form.append('file', file);
        form.append('outputFormat', outputFormat);

        setMsg(el('createStatus'), 'Creating...', true);
        el('createResult').textContent = '';

        const res = await fetch('/api/jobs', { method: 'POST', body: form });
        const text = await res.text();

        if (!res.ok) {
            setMsg(el('createStatus'), `Error ${res.status}`, false);
            el('createResult').textContent = text;
            return;
        }

        setMsg(el('createStatus'), `Created (HTTP ${res.status})`, true);
        el('createResult').textContent = text;

        try {
            const data = JSON.parse(text);
            el('jobId').value = data.id;
            el('downloadJobId').value = data.id;
        } catch(e) {}
    }

    async function checkJob(id) {
        if (!id) {
            setMsg(el('checkStatus'), 'Paste a job id first', false);
            return;
        }

        setMsg(el('checkStatus'), 'Loading...', true);
        el('checkResult').textContent = '';

        const res = await fetch(`/api/jobs/${encodeURIComponent(id)}`);
        const text = await res.text();

        if (!res.ok) {
            setMsg(el('checkStatus'), `Error ${res.status}`, false);
            el('checkResult').textContent = text;
            return null;
        }

        setMsg(el('checkStatus'), 'OK', true);
        el('checkResult').textContent = text;

        try { return JSON.parse(text); } catch(e) { return null; }
    }

    function startPolling() {
        const id = el('jobId').value.trim();
        if (!id) { setMsg(el('checkStatus'), 'Paste a job id first', false); return; }

        if (pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(async () => {
            const data = await checkJob(id);
            if (data && data.status === 'DONE') {
                setMsg(el('checkStatus'), 'DONE ✅ (poll stopped)', true);
                clearInterval(pollTimer);
                pollTimer = null;
            }
            if (data && data.status === 'FAILED') {
                setMsg(el('checkStatus'), 'FAILED ❌ (poll stopped)', false);
                clearInterval(pollTimer);
                pollTimer = null;
            }
        }, 2000);

        setMsg(el('checkStatus'), 'Polling every 2s...', true);
    }

    function stopPolling() {
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = null;
        setMsg(el('checkStatus'), 'Polling stopped', true);
    }

    async function downloadJob() {
        const id = el('downloadJobId').value.trim();
        if (!id) { setMsg(el('downloadStatus'), 'Paste a job id first', false); return; }

        setMsg(el('downloadStatus'), 'Requesting download...', true);

        const res = await fetch(`/api/jobs/${encodeURIComponent(id)}/download`);
        if (!res.ok) {
            const text = await res.text();
            setMsg(el('downloadStatus'), `Error ${res.status}: ${text}`, false);
            return;
        }

        // Force browser download
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `job-${id}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        setMsg(el('downloadStatus'), 'Downloaded ✅', true);
    }

    el('createBtn').addEventListener('click', createJob);
    el('checkBtn').addEventListener('click', () => checkJob(el('jobId').value.trim()));
    el('pollBtn').addEventListener('click', startPolling);
    el('stopPollBtn').addEventListener('click', stopPolling);
    el('downloadBtn').addEventListener('click', downloadJob);
</script>
</body>
</html>
